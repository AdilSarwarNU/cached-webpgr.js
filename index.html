<!doctype html>
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title></title>
  <script type="text/javascript">
  var t1 = new Date();

  
  /**
   * ##_cacheScript
   * This function requires IE7+, Firefox, Chrome, Opera, Safari
   * @param {string} name localStorage identifier; shoud be the same as on the server-side 
   * @param {string} url `path/to/script.js`; shoud be the same as on the server-side 
   */
  function _cacheScript(name, version, url) {
    var xmlhttp = new XMLHttpRequest(); // code for IE7+, Firefox, Chrome, Opera, Safari
    xmlhttp.onreadystatechange = function() {
      if (xmlhttp.readyState == 4) {
        if (xmlhttp.status == 200) {
          localStorage.setItem(name, JSON.stringify({content: xmlhttp.responseText, version: version }));
        } else {
          console.warn('something else other than 200 was returned');
        }
      }
    }
    xmlhttp.open("GET", url, true);
    xmlhttp.send();
  }
  /**
   * ##_loadScript
   * For loading external scripts (local or cross domain)
   * @param {string} url (see `requireScript`)
   * @param {string} name (see `requireScript`)
   * @param {string} version (see `requireScript`)
   * @param {Function} callback (see `requireScript`)
   */
  function _loadScript(url, name, version, callback) {
    var s = document.createElement('script');
    
    if (s.readyState) { //IE
      s.onreadystatechange = function() {
        if (s.readyState == "loaded" || s.readyState == "complete") {
          s.onreadystatechange = null;
          _cacheScript(name, version, url);
          if (callback) callback();
        }
      };
    } else { //Others
      s.onload = function() {
        _cacheScript(name, version, url);
        if (callback) callback();
      };
    }
    
    s.setAttribute("src", url); 
    document.getElementsByTagName("head")[0].appendChild(s)
  }
  
  /**
   * ##_injectScript
   * Injects a script loaded from localStorage into the DOM.
   * If the script version is differnt than the requested one, the localStorage key is cleared and a new version will be loaded next time. 
   * @param {object} content `{content: '// scrip content $(document).ready(...)'}` (`src` should be `undefined` when this is used)
   * @param {string} name (see `requireScript`)
   * @param {string} version (see `requireScript`)
   * @param {Function} callback (see `requireScript`)
   */
  function _injectScript(content, name, version, callback){
    var s = document.createElement('script');
    s.type = "text/javascript";
    var c = JSON.parse(content)
    var scriptContent = document.createTextNode(c.content);
    s.appendChild(scriptContent);
    document.getElementsByTagName("head")[0].appendChild(s)
    
    // cached version is not the request version, clear the cache, this will trigger a reload next time
    if(c.version != version){
      localStorage.removeItem(name);
    }
    
    if(callback) callback();
  }

  /**
   * ##requireScript
   * If the requested script is not available in the localStorage it will be loaded from the provided url (see `_loadScript`).
   * If the script is present in the localStorage it will be injected (see `_injectScript`) into the DOM.   
   * @param {string} name identifier of the script in the local cache
   * @param {string} version version string that is used to check if the script needs to be updated
   * @param {string} url  `path/to/script.js` that should be caced; can be local or cross domain
   * @param {Function} callback function that is extecuted once the script is loaded
   */
  function requireScript(name, version, url, callback) {
    var c = localStorage.getItem(name);
    if (c == null) {
      _loadScript(url, name, version, callback);
    } else {
      _injectScript(c, name, version, callback);
    }
  }

  // ---
  
  requireScript('jquery', '1.11.2', 'http://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js', function(){
    requireScript('examplejs', '0.0.3', 'example.js');
  });

  </script>
</head>
<body>
  <h1>localStorage Script Caching Demo</h1>
  <p>This code demonstrates how to use the localStorage to cache and JavaScrip files. <br>
  Cached files will be loaded much faster than scripts from any server (even local ones). <br>
  My test showed:
  <table>
    <tbody>
      <tr>
        <td>Loading jQuery from CDN</td>
        <th>268ms</th>
      </tr>
      <tr>
        <td>Loading jQuery from localStorage</td>
        <th>47ms</th>
      </tr>
    </tbody>
  </table>
  <br>
  <sub>
    This demo will only work on a server, file:// is not supported.
  </sub>
  </p>
</body>
</html>